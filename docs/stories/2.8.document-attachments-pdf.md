# Story 2.8: Document Attachments (PDF)

## Status

**Approved**

---

## Story

**As a** user,
**I want** to attach and send PDF documents in my conversations,
**so that** I can share files and documents with others.

---

## Acceptance Criteria

1. Document picker accessible via attachment button in message input bar (after image picker option)
2. PDF file validation enforces 10MB maximum size limit
3. Upload progress indicator shows percentage during Firebase Storage upload
4. Document appears optimistically in chat while uploading (with loading indicator)
5. MessageKit displays document message as card with file icon, name, and size
6. Tapping document card opens QuickLook viewer for PDF viewing
7. Failed uploads show retry option with clear error message
8. Firebase Storage security rules enforce 10MB limit and conversation participant access
9. Messages support single PDF attachment (multi-file deferred to post-MVP)
10. Offline queue: PDFs queued locally, uploaded when connection restored
11. Storage path structure: `documents/{conversationId}/{messageId}/document.pdf`
12. Document thumbnails use system file icon (no PDF rendering for MVP)
13. Unit tests for document upload, validation, and error handling
14. Integration test: Upload PDF, verify appears for other participants within 3 seconds
15. Performance: Document upload completes within 10 seconds on WiFi for 10MB PDF
16. Regression test: Text messages, images, editing, read receipts still work with document messages

---

## Previous Story Context (Story 2.7 Completion)

### Key Learnings from Story 2.7

**Upload Infrastructure:**
- StorageRepositoryProtocol extended with `uploadMessageImage` method
- Progress tracking using @Published properties in ChatViewModel
- Optimistic UI pattern: Show attachment immediately in chat
- Cancellation support for in-progress uploads
- Error handling with retry mechanism

**MessageKit Integration:**
- Image messages display using MessageKit's built-in photo support
- Custom progress overlays for upload states
- Tap gesture handling for full-screen viewing
- Integration with existing message bubble layout

**Performance & UX:**
- Image compression reduced file sizes by 60-70%
- Upload progress provides real-time feedback
- Offline queue ensures no data loss
- Failed uploads clearly indicate retry options

### Impact on Story 2.8

Story 2.8 **reuses 90% of Story 2.7's infrastructure**:
- **Storage Repository**: Same upload pattern, different file type
- **Progress Tracking**: Same @Published properties in ChatViewModel
- **Optimistic UI**: Same message append pattern
- **Error Handling**: Same retry/cancel mechanism
- **Firebase Storage**: Same security rules pattern (documents path instead of images path)

**Key Differences:**
- **Picker**: UIDocumentPickerViewController instead of UIImagePickerController
- **Viewer**: QuickLook instead of full-screen image viewer
- **UI**: Document card (icon + name + size) instead of image bubble
- **Size Limit**: 10MB instead of 2MB
- **Validation**: MIME type checking (application/pdf) instead of image formats

---

## What's Already Done (Infrastructure from Previous Stories)

### ✅ Message Entity with Attachment Support (Epic 1, Story 1.3)

The `Message` entity already includes the `attachments` field:

**File:** `MessageAI/Domain/Entities/Message.swift`

```swift
struct Message: Codable, Equatable, Identifiable {
    let id: String
    let conversationId: String
    let senderId: String
    var text: String
    let timestamp: Date
    var status: MessageStatus
    var attachments: [MessageAttachment]  // ✅ ALREADY EXISTS
    // ... other fields
}
```

### ✅ MessageAttachment Entity (Epic 1, Story 1.3)

**File:** `MessageAI/Domain/Entities/MessageAttachment.swift`

```swift
struct MessageAttachment: Codable, Equatable {
    let id: String
    let type: AttachmentType
    let url: String              // Firebase Storage download URL
    let thumbnailURL: String?    // Optional thumbnail URL
    let sizeBytes: Int64         // File size for display
    let fileName: String?        // NEW: File name for documents (e.g., "Invoice.pdf")

    enum AttachmentType: String, Codable {
        case image               // ✅ Story 2.7
        case video              // Future
        case file               // ✅ Story 2.8 - PDF documents
    }
}
```

**Note:** `fileName` field may need to be added to MessageAttachment if not already present.

### ✅ StorageRepositoryProtocol (Story 2.7)

**File:** `MessageAI/Domain/Repositories/StorageRepositoryProtocol.swift`

```swift
protocol StorageRepositoryProtocol {
    func uploadProfileImage(_ image: UIImage, userId: String) async throws -> String
    func deleteFile(at path: String) async throws

    // Added in Story 2.7:
    func uploadMessageImage(_ image: UIImage, conversationId: String, messageId: String, progressHandler: ((Double) -> Void)?) async throws -> MessageAttachment
    func cancelUpload(for messageId: String) async throws

    // Story 2.8 will ADD:
    // func uploadMessageDocument(_ fileURL: URL, conversationId: String, messageId: String, progressHandler: ((Double) -> Void)?) async throws -> MessageAttachment
}
```

### ✅ FirebaseStorageRepository Implementation (Story 2.7)

**File:** `MessageAI/Data/Repositories/FirebaseStorageRepository.swift`

Image upload infrastructure complete with:
- Progress tracking with Combine publishers
- Error handling with user-friendly StorageError enum
- Firebase Storage SDK integration
- Metadata setting (content-type)
- Cancellation support

Story 2.8 will extend this repository with document upload method.

### ✅ Firebase Storage Security Rules (Story 2.7)

**File:** `storage.rules`

Existing rules for images:

```javascript
// Image attachments: /images/{conversationId}/{messageId}/{filename}
match /images/{conversationId}/{messageId}/{filename} {
  allow write: if isAuthenticated() && isParticipant(conversationId) && request.resource.size < 2 * 1024 * 1024;
  allow read: if isAuthenticated() && isParticipant(conversationId);
}
```

**Story 2.8 will ADD:**

```javascript
// Document attachments: /documents/{conversationId}/{messageId}/{filename}
match /documents/{conversationId}/{messageId}/{filename} {
  // Allow upload if authenticated and participant (with 10MB limit)
  allow write: if isAuthenticated()
    && isParticipant(conversationId)
    && request.resource.size < 10 * 1024 * 1024  // 10MB limit
    && request.resource.contentType == 'application/pdf';

  // Allow read if authenticated and participant
  allow read: if isAuthenticated() && isParticipant(conversationId);
}
```

### ✅ ChatViewModel Upload State Management (Story 2.7)

**File:** `MessageAI/Presentation/ViewModels/Chat/ChatViewModel.swift`

```swift
@MainActor
class ChatViewModel: ObservableObject {
    // Added in Story 2.7:
    @Published var uploadProgress: [String: Double] = [:]
    @Published var uploadErrors: [String: String] = [:]
    @Published var isImagePickerPresented: Bool = false
    @Published var selectedImage: UIImage?

    // Story 2.8 will ADD:
    // @Published var isDocumentPickerPresented: Bool = false
    // @Published var selectedDocumentURL: URL?
}
```

---

## What's NEW in Story 2.8

Story 2.8 adds the **iOS client-side implementation** for PDF document attachments:

### 1. StorageRepositoryProtocol Extension

**NEW METHOD:**
```swift
/// Upload message document (PDF) with progress tracking
func uploadMessageDocument(
    _ fileURL: URL,
    conversationId: String,
    messageId: String,
    progressHandler: ((Double) -> Void)?
) async throws -> MessageAttachment
```

### 2. FirebaseStorageRepository Implementation

**NEW:**
- PDF file validation (MIME type, size limit)
- Upload progress tracking (reuses Story 2.7 pattern)
- Storage path: `documents/{conversationId}/{messageId}/document.pdf`
- File size enforcement (10MB max)
- Error mapping for user-friendly messages

### 3. ChatViewModel Document Upload Logic

**NEW:**
- `@Published var isDocumentPickerPresented: Bool` - Control document picker
- `@Published var selectedDocumentURL: URL?` - Selected file URL
- `selectDocument()` - Open document picker
- `sendDocumentMessage(fileURL: URL)` - Validate, upload, send
- `retryDocumentUpload(messageId: String)` - Retry failed upload

### 4. DocumentPickerView SwiftUI Component

**NEW FILE:** `MessageAI/Presentation/Components/DocumentPickerView.swift`

UIViewControllerRepresentable wrapper for UIDocumentPickerViewController

### 5. Document Card UI Component

**NEW FILE:** `MessageAI/Presentation/Components/DocumentCardView.swift`

Custom SwiftUI view displaying:
- File icon (SF Symbol: doc.fill)
- File name (e.g., "Invoice.pdf")
- File size (formatted, e.g., "2.5 MB")
- Upload progress overlay (if uploading)
- Tap to open QuickLook

### 6. QuickLook Integration

**NEW:** QuickLook preview for viewing PDFs in-app

### 7. ChatView Integration

**UPDATE:**
- Add document picker option alongside image picker
- Display DocumentPickerView sheet when document button tapped
- Show document upload progress
- Handle document message taps for QuickLook

### 8. MessageKit DataSource Updates

**UPDATE:** `ChatViewModel` MessageKit integration to support document messages as custom cells

### 9. Unit Tests

**NEW FILE:** `MessageAITests/Presentation/ViewModels/ChatViewModelDocumentTests.swift`

Test document validation, upload, retry, cancellation

---

## Dev Notes

### Previous Story Insights

[Source: Story 2.7 Completion Notes]

**Key Patterns to Reuse:**
- Optimistic UI: Append message immediately with `.sending` status
- Progress tracking: Use `uploadProgress[messageId]` dictionary
- Error handling: Set `uploadErrors[messageId]` on failure
- Cancellation: Store upload tasks in dictionary for cancellation
- Offline queue: Messages persist locally until uploaded

**Story 2.7 Established Infrastructure:**
- `StorageRepositoryProtocol` with progress handler pattern
- `ChatViewModel` upload state management (@Published properties)
- Firebase Storage security rules pattern
- MessageKit integration with custom cells
- Unit test patterns for upload scenarios

### Data Models

[Source: docs/architecture/data-models.md#Message]

**MessageAttachment Entity:**
```swift
struct MessageAttachment: Codable, Equatable {
    let id: String
    let type: AttachmentType           // .file for PDFs
    let url: String                    // Firebase Storage download URL
    let thumbnailURL: String?          // nil for documents (no thumbnail generation)
    let sizeBytes: Int64               // File size in bytes
    let fileName: String?              // "Invoice.pdf" - REQUIRED for documents

    enum AttachmentType: String, Codable {
        case image  // Story 2.7
        case video  // Future
        case file   // Story 2.8 - PDF
    }
}
```

**fileName Field:**
- If not present in MessageAttachment entity, ADD it
- Required for document attachments to display file name
- Optional for images (not displayed)

### API Specifications

[Source: docs/architecture/tech-stack.md#Firebase Storage]

**Firebase Storage:**
- SDK: Firebase Storage 10.x
- Upload method: `putDataAsync()` with progress observer
- Path structure: `documents/{conversationId}/{messageId}/document.pdf`
- Size limit: 10MB (10 * 1024 * 1024 bytes)
- MIME type: `application/pdf`
- Security: Conversation participant access only

**UIDocumentPickerViewController:**
- Document types: `["public.pdf"]`
- Mode: `.import` (copies file to app's Documents directory)
- Delegate: UIDocumentPickerDelegate

**QuickLook Framework:**
- Framework: QuickLook (iOS native)
- Preview controller: `QLPreviewController`
- Data source: `QLPreviewControllerDataSource`
- File handling: Download PDF to temporary directory, pass local URL

### Component Specifications

[Source: docs/architecture/ios-app-architecture.md#Presentation/Components]

**DocumentPickerView:**
- Location: `MessageAI/Presentation/Components/DocumentPickerView.swift`
- Type: UIViewControllerRepresentable
- Wraps: UIDocumentPickerViewController
- Returns: URL via binding
- Document types: `[UTType.pdf]` (UniformTypeIdentifiers framework)

**DocumentCardView:**
- Location: `MessageAI/Presentation/Components/DocumentCardView.swift`
- Type: SwiftUI View
- Displays: SF Symbol "doc.fill", file name, file size
- Actions: Tap to open QuickLook
- Upload state: Progress overlay when uploading

**QuickLookPreview:**
- Location: `MessageAI/Presentation/Components/QuickLookPreview.swift`
- Type: UIViewControllerRepresentable
- Wraps: QLPreviewController
- Input: Local file URL (download from Firebase Storage first)

### File Locations

[Source: docs/architecture/ios-app-architecture.md]

**Domain Layer:**
- `MessageAI/Domain/Repositories/StorageRepositoryProtocol.swift` - Add uploadMessageDocument method

**Data Layer:**
- `MessageAI/Data/Repositories/FirebaseStorageRepository.swift` - Implement uploadMessageDocument
- Update MockStorageRepository with document methods

**Presentation Layer:**
- `MessageAI/Presentation/ViewModels/Chat/ChatViewModel.swift` - Add document upload logic
- `MessageAI/Presentation/Components/DocumentPickerView.swift` - NEW
- `MessageAI/Presentation/Components/DocumentCardView.swift` - NEW
- `MessageAI/Presentation/Components/QuickLookPreview.swift` - NEW
- `MessageAI/Presentation/Views/Chat/ChatView.swift` - Integrate document picker

**Tests:**
- `MessageAITests/Presentation/ViewModels/ChatViewModelDocumentTests.swift` - NEW
- `MessageAITests/Data/Mocks/MockStorageRepository.swift` - Update

**Firebase:**
- `storage.rules` - Add /documents path rules

### Testing Requirements

[Source: docs/architecture/testing-strategy.md]

**Unit Tests (Story-Level):**
- Test document validation (size limit, MIME type)
- Test upload success and failure scenarios
- Test progress tracking updates
- Test retry mechanism
- Test cancellation
- Test offline queueing

**Integration Tests:**
- Upload PDF to Firebase Storage (with emulator)
- Verify document appears for other participants
- Test QuickLook preview opens correctly

**Performance Tests:**
- 10MB upload < 10 seconds on WiFi
- Verify no memory leaks with large PDFs

**Regression Tests:**
- Verify text messages still work
- Verify image messages still work
- Verify message editing still works
- Verify read receipts still work

**Testing Commands:**
```bash
# Story-level tests (5-10 seconds)
./scripts/test-story.sh ChatViewModelDocumentTests

# Epic-level tests (20-40 seconds) - before marking complete
./scripts/test-epic.sh 2

# Full regression (1-2 minutes) - before commit
./scripts/quick-test.sh
```

### Technical Constraints

[Source: docs/architecture/coding-standards.md, tech-stack.md]

**iOS Requirements:**
- Swift 5.9+ with async/await
- SwiftUI for all UI components
- @MainActor for all ViewModels
- Protocol-oriented architecture (no direct Firebase imports in Domain)

**Firebase Storage Constraints:**
- Max file size: 10MB (enforced in security rules AND client-side)
- Supported MIME type: `application/pdf` only
- Path structure: `documents/{conversationId}/{messageId}/document.pdf`
- Security: Only conversation participants can read/write

**Performance Targets:**
- Upload latency: < 10 seconds for 10MB file on WiFi
- UI responsiveness: Optimistic UI must appear < 100ms
- Memory: No memory leaks with large file handling

**Code Quality:**
- 70%+ test coverage
- No force unwrapping (!)
- All errors handled with user-friendly messages
- Accessibility labels on all interactive elements

### Security Considerations

[Source: firebase-storage-security.rules]

**Storage Security Rules:**
- Enforce 10MB size limit server-side
- Validate MIME type is `application/pdf`
- Verify user is conversation participant via Firestore lookup
- Only authenticated users can upload/download

**Client-Side Validation:**
- Check file size BEFORE upload (prevent wasted bandwidth)
- Validate file extension is .pdf
- Verify UTType matches PDF

---

## Tasks / Subtasks

### Task 0: Check Existing Implementation (AC: Foundation) [CRITICAL - Do First]
- [ ] Search protocol for `uploadMessageDocument` - check if already exists
- [ ] Check FirebaseStorageRepository for document upload implementation
- [ ] Verify ChatViewModel has document picker state
- [ ] Check if DocumentPickerView component exists
- [ ] Review MockStorageRepository for document method mocking
- [ ] Check storage.rules for /documents path rules
- [ ] **If 80%+ exists:** Skip to missing pieces only (see Story 2.5 lesson)

### Task 1: Add fileName to MessageAttachment (If Missing) (AC: 5)
- [ ] Check if `fileName: String?` exists in MessageAttachment entity
- [ ] If missing, add field to MessageAttachment struct
- [ ] Update Firestore mappers to include fileName field
- [ ] Update mock MessageAttachment creators in tests

### Task 2: Extend StorageRepositoryProtocol (AC: 3, 7, 10)
- [ ] Add `uploadMessageDocument(_:conversationId:messageId:progressHandler:) async throws -> MessageAttachment`
- [ ] Document method behavior (validation, progress, cancellation)
- [ ] Reuse existing `cancelUpload(for:)` method (works for documents too)
- [ ] Add methods to MockStorageRepository with tracking booleans

### Task 3: Implement Document Validation Utility (AC: 2)
- [ ] Create `MessageAI/Presentation/Utils/DocumentValidator.swift`
- [ ] Implement `validate(fileURL: URL) throws -> (fileName: String, sizeBytes: Int64)`
- [ ] Check file size <= 10MB (10 * 1024 * 1024 bytes)
- [ ] Check MIME type is `application/pdf`
- [ ] Throw descriptive errors: FileTooLargeError, UnsupportedFileTypeError
- [ ] Return file name and size for UI display

### Task 4: Implement uploadMessageDocument in FirebaseStorageRepository (AC: 3, 8, 11, 15)
- [ ] Validate document using DocumentValidator utility
- [ ] Create storage path: `documents/{conversationId}/{messageId}/document.pdf`
- [ ] Read file data using `Data(contentsOf: fileURL)`
- [ ] Create StorageReference and metadata (contentType: application/pdf)
- [ ] Use `putDataAsync()` with progress observer (reuse Story 2.7 pattern)
- [ ] Call progressHandler closure with upload percentage (0.0-1.0)
- [ ] Get download URL after upload completes
- [ ] Create MessageAttachment with URL, size, type: .file, fileName
- [ ] Handle errors with StorageError translation
- [ ] Log upload duration and final size

### Task 5: Add Document Upload Logic to ChatViewModel (AC: 1, 4, 7, 10)
- [ ] Add `@Published var isDocumentPickerPresented: Bool = false`
- [ ] Add `@Published var selectedDocumentURL: URL?`
- [ ] Implement `selectDocument()` method (sets isDocumentPickerPresented = true)
- [ ] Implement `sendDocumentMessage(fileURL: URL)` method:
  - Generate message ID
  - Validate document using DocumentValidator
  - Create Message with empty text, status: .sending, attachments: []
  - Append to messages array (optimistic UI)
  - Upload document in background Task
  - Update uploadProgress[messageId] during upload
  - On success: Update message with attachment, set status: .sent
  - On failure: Set uploadErrors[messageId], show retry UI
- [ ] Implement `retryDocumentUpload(messageId: String)` method (reuses sendDocumentMessage logic)
- [ ] Handle network reconnection (reuse Story 2.7 pattern)

### Task 6: Create DocumentPickerView Component (AC: 1)
- [ ] Create `MessageAI/Presentation/Components/DocumentPickerView.swift`
- [ ] UIViewControllerRepresentable wrapping UIDocumentPickerViewController
- [ ] Document types: `[UTType.pdf]`
- [ ] Mode: `.import` (copy file to app)
- [ ] Coordinator pattern for delegate methods
- [ ] Return selected file URL via binding
- [ ] Handle cancellation

### Task 7: Create DocumentCardView Component (AC: 5)
- [ ] Create `MessageAI/Presentation/Components/DocumentCardView.swift`
- [ ] Display SF Symbol "doc.fill" icon
- [ ] Display file name (e.g., "Invoice.pdf")
- [ ] Display formatted file size (e.g., "2.5 MB")
- [ ] Add tap gesture for opening QuickLook
- [ ] Show CircularProgressView overlay when uploading
- [ ] Show error overlay with retry button when upload fails
- [ ] Use rounded rectangle background with shadow

### Task 8: Create QuickLookPreview Component (AC: 6)
- [ ] Create `MessageAI/Presentation/Components/QuickLookPreview.swift`
- [ ] UIViewControllerRepresentable wrapping QLPreviewController
- [ ] Download PDF from Firebase Storage URL to temporary directory
- [ ] Implement QLPreviewControllerDataSource
- [ ] Return local file URL for preview
- [ ] Add close button
- [ ] Handle errors (download failure, unsupported file)

### Task 9: Integrate DocumentPickerView into ChatView (AC: 1)
- [ ] Add document button (paperclip icon) next to existing attachment button
- [ ] Create menu: "Photo" or "Document"
- [ ] Bind document button tap to viewModel.selectDocument()
- [ ] Display DocumentPickerView sheet when isDocumentPickerPresented = true
- [ ] Pass selected fileURL to viewModel.sendDocumentMessage(fileURL:)
- [ ] Add loading indicator during validation/upload

### Task 10: Display Upload Progress on Document Messages (AC: 3, 4)
- [ ] Integrate DocumentCardView into MessageKit custom cell
- [ ] Overlay CircularProgressView when uploadProgress[messageId] exists
- [ ] Show percentage text (e.g., "45%")
- [ ] Hide progress overlay when uploadProgress[messageId] == 1.0
- [ ] Show error overlay with retry button when uploadErrors[messageId] exists

### Task 11: Handle Document Message Taps (QuickLook View) (AC: 6)
- [ ] Add tap gesture recognizer to document card in MessageKit
- [ ] Present QuickLookPreview when document message tapped
- [ ] Pass document URL to QuickLookPreview
- [ ] Use fullScreenCover modifier for presentation
- [ ] Handle download errors gracefully

### Task 12: Update MessageKit DataSource for Document Messages (AC: 5)
- [ ] Update ChatViewModel to handle `.file` attachment type
- [ ] Create custom MessageKit cell for document messages
- [ ] Display DocumentCardView in custom cell
- [ ] Set appropriate cell size based on document card dimensions
- [ ] Ensure tap handling works with MessageKit gesture system

### Task 13: Add Firebase Storage Security Rules (AC: 8)
- [ ] Edit `storage.rules` file
- [ ] Add /documents/{conversationId}/{messageId}/{filename} path
- [ ] Enforce 10MB size limit server-side
- [ ] Enforce `application/pdf` content type
- [ ] Require user is conversation participant (isParticipant helper)
- [ ] Deploy rules: `firebase deploy --only storage:rules --project messageai-dev`

### Task 14: Write Unit Tests for Document Upload (AC: 13)
- [ ] Create `MessageAITests/Presentation/ViewModels/ChatViewModelDocumentTests.swift`
- [ ] Test selectDocument() opens document picker
- [ ] Test sendDocumentMessage() validates file size
- [ ] Test sendDocumentMessage() validates MIME type
- [ ] Test upload progress updates correctly
- [ ] Test successful upload updates message with attachment
- [ ] Test failed upload marks message as failed
- [ ] Test retryDocumentUpload() retries failed upload
- [ ] Test cancelDocumentUpload() cancels in-progress upload
- [ ] Test offline queue persists documents

### Task 15: Write Unit Tests for DocumentValidator (AC: 2, 13)
- [ ] Test validation passes for valid PDF under 10MB
- [ ] Test validation fails for file over 10MB
- [ ] Test validation fails for non-PDF file
- [ ] Test validation extracts correct file name
- [ ] Test validation extracts correct file size

### Task 16: Write Integration Tests (AC: 14)
- [ ] Create integration test: Upload PDF, verify appears for recipient
- [ ] Test QuickLook preview opens and displays PDF correctly
- [ ] Test document download from Firebase Storage
- [ ] Requires Firebase Emulator running

### Task 17: Run Story-Level Tests (AC: 13)
- [ ] Run `./scripts/test-story.sh ChatViewModelDocumentTests`
- [ ] Verify all tests pass
- [ ] Fix any failures
- [ ] Achieve 70%+ test coverage for new code

### Task 18: Run Epic-Level Regression Tests (AC: 16)
- [ ] Run `./scripts/test-epic.sh 2`
- [ ] Verify all Epic 2 features still work (text, images, editing, read receipts)
- [ ] Fix any regressions
- [ ] Ensure 40+ tests pass

### Task 19: Manual Testing (AC: 5, 6, 14, 15, 16)
- [ ] Test document picker opens and allows PDF selection
- [ ] Test file size validation (reject file > 10MB)
- [ ] Test upload progress displays correctly
- [ ] Test document card displays file name and size
- [ ] Test QuickLook opens and displays PDF
- [ ] Test failed upload shows retry option
- [ ] Test offline queue: Upload when offline, succeeds when online
- [ ] Test document appears for recipient within 3 seconds
- [ ] Test 10MB document uploads within 10 seconds on WiFi
- [ ] Test text messages, images, editing still work with documents present

---

## Acceptance Criteria Checklist

- [ ] **AC 1:** Document picker accessible via attachment button
- [ ] **AC 2:** PDF file validation enforces 10MB limit
- [ ] **AC 3:** Upload progress indicator shows percentage
- [ ] **AC 4:** Document appears optimistically while uploading
- [ ] **AC 5:** MessageKit displays document card (icon, name, size)
- [ ] **AC 6:** Tapping document opens QuickLook viewer
- [ ] **AC 7:** Failed uploads show retry option
- [ ] **AC 8:** Firebase Storage rules enforce 10MB limit and participant access
- [ ] **AC 9:** Messages support single PDF attachment
- [ ] **AC 10:** Offline queue uploads when connection restored
- [ ] **AC 11:** Storage path: `documents/{conversationId}/{messageId}/document.pdf`
- [ ] **AC 12:** Document thumbnails use system file icon
- [ ] **AC 13:** Unit tests for upload, validation, error handling
- [ ] **AC 14:** Integration test: Upload PDF, verify appears within 3 seconds
- [ ] **AC 15:** Performance: 10MB upload < 10 seconds on WiFi
- [ ] **AC 16:** Regression tests pass (text, images, editing, read receipts)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Story created - Document Attachments (PDF) | Bob (SM) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes

*To be filled by dev agent*

### File List

*To be filled by dev agent*

---

## QA Results

*This section will be populated by QA agent after implementation.*
