# Story 2.13: Bug Fixes - Unread Badges & Message Pagination

## Status

**Draft**

## Story

**As a** MessageAI user,
**I want** unread message counts to display correctly on conversation list badges and the app icon, and to be able to load older messages by scrolling up in long conversations,
**so that** I can see which conversations need my attention and access my complete message history.

## Context

This story addresses two critical bugs discovered during Story 2.12 QA review:

1. **Unread Count Badges Not Working**: Conversation list shows badge UI component, but `unreadCounts` dictionary is always empty. Badges never appear despite unread messages existing.
2. **Message Pagination Not Triggering**: Initial 50 message limit works, but scrolling to load older messages does not trigger. Users cannot access messages beyond the initial 50.

Both features have complete UI and data model implementation, but are missing critical backend logic (badges) or have a broken trigger mechanism (pagination).

## Root Cause Analysis

### Bug #1: Unread Count Badges

**Files Affected:**
- `ConversationRowView.swift:39-41, 115-124` - UI exists ✅
- `Conversation.swift:11, 32-34` - Data model exists ✅
- `ConversationsListViewModel.swift:110-120` - App icon badge update exists ✅
- `functions/src/index.ts:13-151` - Cloud Function missing increment logic ❌

**Issue:**
The Cloud Function `sendMessageNotification` sends push notifications but does NOT increment the `unreadCounts` field in the conversation document. The field remains empty `{}` instead of tracking per-user unread counts like `{"userB": 3, "userC": 1}`.

**Expected Flow:**
1. User A sends message
2. Cloud Function triggers on message creation
3. Function increments `unreadCounts.userB` and `unreadCounts.userC` in Firestore
4. Real-time listener updates UI badges

**Actual Flow:**
1. User A sends message
2. Cloud Function triggers on message creation
3. Function sends notifications ONLY ❌
4. `unreadCounts` remains empty `{}`
5. Badges never show

### Bug #2: Message Pagination

**Files Affected:**
- `ChatView.swift:947-954` - Scroll detection exists ✅
- `ChatViewModel.swift:468-512` - `loadMoreMessages()` exists ✅
- `FirebaseMessageRepository.swift:232-262` - Repository method exists ✅
- `FirebaseMessageRepository.swift:68` - 50 message limit works ✅

**Issue:**
The scroll trigger `if offsetY < 200` never fires. Likely cause: MessageKit uses inverted coordinate system where newest messages are at scroll offset 0, and older messages are loaded by scrolling DOWN (increasing offset), not UP.

**Expected Flow:**
1. User scrolls to top of message list
2. `scrollViewDidScroll` detects `offsetY < 200`
3. Calls `loadMoreMessages()`
4. Older messages prepended to array

**Actual Flow:**
1. User scrolls to top of message list
2. Trigger never fires (wrong coordinate check) ❌
3. No pagination occurs

## Acceptance Criteria

### Bug #1: Unread Count Badges

1. ✅ **Backend Logic**: Cloud Function increments `conversation.unreadCounts.{userId}` by 1 when a new message is created
2. ✅ **Skip If Viewing**: Cloud Function does NOT increment unread count if recipient's `currentConversationId` matches the conversation (user is viewing)
3. ✅ **Real-time Update**: Conversation list badges update immediately when `unreadCounts` changes via Firestore listener
4. ✅ **Mark as Read**: When user opens conversation, `unreadCounts.{userId}` resets to 0 in Firestore
5. ✅ **App Icon Badge**: App icon badge displays total unread count across all conversations
6. ✅ **Persistence**: Unread counts survive app restart (stored in Firestore)

### Bug #2: Message Pagination

7. ✅ **Initial Limit**: Chat view loads only 50 most recent messages on open (existing behavior, verify still works)
8. ✅ **Scroll Trigger**: Scrolling near the top of message list triggers `loadMoreMessages()`
9. ✅ **Load Older Messages**: `loadMoreMessages()` fetches next 50 messages older than the current oldest message
10. ✅ **No Duplicates**: Paginated messages are not duplicated in the UI
11. ✅ **Loading Indicator**: UI shows loading state while fetching older messages
12. ✅ **End Detection**: Pagination stops when no more messages exist (sets `hasMoreMessages = false`)
13. ✅ **Preserve Real-time**: Real-time listener for new messages continues working after pagination

### Testing & Validation

14. ✅ **Manual Test - Badges**: Two users send messages, verify badges show correct counts
15. ✅ **Manual Test - Pagination**: Create conversation with 100+ messages, verify all messages loadable
16. ✅ **Unit Tests**: All affected components have passing unit tests
17. ✅ **Integration Test**: Full flow test with Firebase Emulator

## Tasks / Subtasks

### Task 1: Fix Unread Count Backend Logic (AC: 1, 2, 3, 4, 5, 6)

- [ ] **1.1** Update Cloud Function `sendMessageNotification` in `functions/src/index.ts`
  - [ ] After sending notifications, create Firestore batch update
  - [ ] For each recipient NOT viewing conversation, increment `unreadCounts.{recipientId}` using `FieldValue.increment(1)`
  - [ ] Skip increment if `userData.isOnline && userData.currentConversationId === conversationId`
  - [ ] Commit batch update to Firestore
  - [ ] Add logging: "Updated unread counts for X recipients"

- [ ] **1.2** Update `markMessagesAsRead()` in `ChatViewModel.swift` to reset Firestore counter
  - [ ] After marking messages as read locally, call `conversationRepository.updateUnreadCount(conversationId, currentUserId, count: 0)`
  - [ ] Verify existing real-time listener in `ConversationsListViewModel.swift:68-93` picks up change

- [ ] **1.3** Verify app icon badge update logic still works
  - [ ] Confirm `updateBadgeCount()` in `ConversationsListViewModel.swift:110-120` calculates total correctly
  - [ ] Ensure `UIApplication.shared.applicationIconBadgeNumber` updates on main thread

### Task 2: Fix Message Pagination Scroll Trigger (AC: 7, 8, 9, 10, 11, 12, 13)

- [ ] **2.1** Add debug logging to `scrollViewDidScroll` in `ChatView.swift:938-955`
  - [ ] Log: `offsetY`, `contentHeight`, `scrollViewHeight`, `hasMoreMessages`, `isLoadingMore`
  - [ ] Run app and scroll to identify actual scroll coordinates for "scrolled to top"

- [ ] **2.2** Fix scroll trigger logic based on MessageKit coordinate system
  - [ ] If MessageKit uses inverted layout (newest at top), change trigger to detect bottom scroll: `offsetY > contentHeight - scrollViewHeight - 200`
  - [ ] If standard layout, verify `offsetY < 200` is correct threshold
  - [ ] Test with manual scroll in simulator

- [ ] **2.3** Add loading indicator UI
  - [ ] Display `ProgressView` at top of message list when `viewModel.isLoadingMore == true`
  - [ ] Hide when `isLoadingMore` returns to `false`

- [ ] **2.4** Verify paginated message preservation logic
  - [ ] Confirm `ChatViewModel.swift:185-193` preserves older messages outside real-time window
  - [ ] Test that real-time listener doesn't remove paginated messages

### Task 3: Testing (AC: 14, 15, 16, 17)

- [ ] **3.1** Add unit tests for unread count logic
  - [ ] Test Cloud Function increment logic (mock Firestore batch)
  - [ ] Test `updateUnreadCount()` repository method
  - [ ] Test badge calculation in `ConversationsListViewModel`

- [ ] **3.2** Add unit tests for pagination
  - [ ] Test `loadMoreMessages()` triggers correctly
  - [ ] Test `hasMoreMessages` flag updates when < 50 messages returned
  - [ ] Test paginated messages prepended to array without duplicates

- [ ] **3.3** Manual testing with Firebase Emulator
  - [ ] **Test A**: Two users, User A sends 5 messages to User B while User B is offline, verify badge shows "5"
  - [ ] **Test B**: User B opens conversation, verify badge clears to "0"
  - [ ] **Test C**: User A sends message while User B is viewing conversation, verify NO badge appears
  - [ ] **Test D**: Create conversation with 150 messages, scroll to top, verify all 150 messages loadable in batches of 50

- [ ] **3.4** Deploy Cloud Function and test in dev environment
  - [ ] Deploy: `firebase deploy --only functions:sendMessageNotification --project messageai-dev-1f2ec`
  - [ ] Test on real devices (iOS Simulator + iPhone)

### Task 4: Documentation & Cleanup

- [ ] **4.1** Update CLAUDE.md if any new patterns introduced
- [ ] **4.2** Remove debug logging added in Task 2.1 after confirming fix
- [ ] **4.3** Update Story 2.11 and 2.10 docs to reference this bug fix story

## Dev Notes

### Relevant File Locations

**Swift/iOS:**
- `MessageAI/Presentation/Views/Chat/ChatView.swift` - Scroll detection (line 938-955)
- `MessageAI/Presentation/ViewModels/Chat/ChatViewModel.swift` - Pagination logic (line 468-512)
- `MessageAI/Presentation/ViewModels/Conversations/ConversationsListViewModel.swift` - Badge update (line 110-120)
- `MessageAI/Presentation/Components/ConversationRowView.swift` - Badge UI (line 39-41, 115-124)
- `MessageAI/Domain/Entities/Conversation.swift` - Data model (line 11, 32-34)
- `MessageAI/Data/Repositories/FirebaseMessageRepository.swift` - Repository (line 232-262)
- `MessageAI/Data/Repositories/FirebaseConversationRepository.swift` - Unread count method (line 226-236)

**Cloud Functions (TypeScript):**
- `functions/src/index.ts` - `sendMessageNotification` (line 13-151)

**Tests:**
- `MessageAITests/Presentation/ViewModels/ChatViewModelPaginationTests.swift` - Pagination tests
- `MessageAITests/Presentation/ViewModels/ConversationsListViewModelTests.swift` - Badge tests

### Previous Story Context

From **Story 2.11 (Performance Optimization)**:
- Pagination was implemented with `loadMoreMessages()` method
- Real-time listener limited to 50 most recent messages
- Pagination trigger added to scroll detection
- **Known Issue**: Pagination trigger may not work with MessageKit's coordinate system

From **Story 2.10 (Push Notifications)**:
- Cloud Function created to send notifications on new messages
- Function checks `currentConversationId` to suppress notifications if user is viewing
- **Missing**: Function does NOT update `unreadCounts` field

From **Story 1.7 (Conversations List UI)**:
- Badge UI component created with conditional rendering: `if unreadCount > 0`
- `Conversation.unreadCounts` dictionary defined as `[String: Int]`
- **Assumption**: Backend would populate `unreadCounts` automatically (NOT implemented)

### Architecture Patterns

**Firestore Batch Writes** [Source: CLAUDE.md:104-123]:
```swift
let batch = db.batch()
batch.updateData(["field": value], forDocument: ref1)
batch.updateData(["field": value], forDocument: ref2)
try await batch.commit()  // Atomic operation
```

**Server Timestamps** [Source: CLAUDE.md:80-99]:
```typescript
admin.firestore.FieldValue.serverTimestamp()  // ALWAYS use server time
```

**Firestore Increment** [Source: Firebase SDK]:
```typescript
batch.update(conversationRef, {
  [`unreadCounts.${userId}`]: admin.firestore.FieldValue.increment(1)
});
```

**Real-time Listener Pattern** [Source: FirebaseConversationRepository.swift:178-223]:
```swift
db.collection("conversations")
  .whereField("participantIds", arrayContains: userId)
  .addSnapshotListener { snapshot, error in
    // Auto-updates when unreadCounts changes
  }
```

### MessageKit Scroll Coordinate System

**Investigation Needed**:
MessageKit's `MessagesCollectionView` may use an inverted layout where:
- Scroll offset 0 = bottom (newest messages)
- Increasing offset = scrolling up to older messages
- Top detection: `offsetY > contentHeight - scrollViewHeight - threshold`

**Standard UIScrollView**:
- Scroll offset 0 = top
- Increasing offset = scrolling down
- Top detection: `offsetY < threshold`

**Debug Strategy**: Add logging to determine actual coordinate behavior, then adjust trigger accordingly.

### Testing Standards

[Source: docs/architecture/testing-best-practices.md]

**Test File Locations:**
- Unit tests: `MessageAITests/` (matching source folder structure)
- Integration tests: `MessageAITests/Integration/`

**Testing Requirements:**
- All repository methods must have unit tests with mock data
- ViewModels must have tests for @Published property changes
- Integration tests must use Firebase Emulator
- Minimum 70% code coverage for modified files

**Test Execution:**
```bash
# Quick unit tests (5-10 seconds)
./scripts/quick-test.sh -q

# Full test suite with coverage
xcodebuild test -scheme MessageAI -destination 'platform=iOS Simulator,name=iPhone 17 Pro' -enableCodeCoverage YES
```

### Cloud Function Development

**Local Testing:**
```bash
# Start Firebase Emulator
firebase emulators:start

# Deploy to dev environment
firebase deploy --only functions --project messageai-dev-1f2ec

# View Cloud Function logs
firebase functions:log --project messageai-dev-1f2ec
```

**TypeScript Compilation:**
Cloud Functions auto-compile on deploy. Errors will block deployment.

### Known Edge Cases

1. **Race Condition**: User A sends message while User B is opening conversation
   - Solution: Check `currentConversationId` in Cloud Function (already implemented)

2. **Offline Increment**: User receives message while offline
   - Solution: Firestore batch update persists even if user is offline

3. **Multiple Devices**: User has app open on iPhone and iPad
   - Solution: `currentConversationId` updates per-device, badge shows on device not viewing

4. **Pagination + Real-time**: New message arrives while paginating
   - Solution: Real-time listener operates on separate query (50 most recent)

### Performance Considerations

[Source: docs/architecture/tech-stack.md]

- **Firestore Read Cost**: Each pagination loads 50 messages (1 read per message)
- **Cloud Function Cost**: Increment operation adds ~5ms to function execution
- **Badge Update Frequency**: Real-time listener triggers on every conversation change (efficient via Firestore SDK)

### Firestore Security Rules

[Source: firestore.rules]

Ensure security rules allow:
```
// Allow updating unreadCounts
match /conversations/{conversationId} {
  allow update: if request.auth.uid in resource.data.participantIds
                && request.resource.data.keys().hasOnly(['unreadCounts']);
}
```

Current rules already permit conversation updates for participants. Verify `unreadCounts` field is not restricted.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Story created - Bug fixes for unread badges & pagination | Scrum Master (Claude Code) |

## Dev Agent Record

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*To be populated by QA agent after implementation*
