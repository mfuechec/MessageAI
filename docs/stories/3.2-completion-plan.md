# Story 3.2: Thread Summarization Feature - Completion Plan

## Current Status

### ✅ Completed
- **SummaryViewModel**: Fully implemented with @MainActor, error handling, loading states
- **SummaryView**: Complete modal UI with loading/error/success states
- **DIContainer**: Factory method `makeSummaryViewModel()` added
- **Unit Tests**: 12 tests, all passing ✅
- **Build**: Project compiles successfully

### ⚠️ Blocked
- **ChatView Integration**: AI button + sheet integration commented out due to Swift compiler complexity limit (ChatView.swift = 1361 lines)

## Problem Summary

ChatView.swift is too complex for the Swift compiler to type-check. Adding the AI button and sheet presentation pushed it over the compiler's limit, causing:
```
error: the compiler is unable to type-check this expression in reasonable time
```

**Affected Code Locations**:
- Lines 20-24: AI state variables (commented out)
- Lines 148-161: AI button in toolbar (commented out)
- Lines 188-205: Confirmation dialog + sheet (commented out)
- Lines 477-490: Helper property for sheet content (commented out)

---

## Recommended Solution: ChatView Refactoring

### Phase 1: Extract Toolbar (Highest Priority)

**Goal**: Reduce ChatView body complexity by extracting toolbar into separate component

**Steps**:

1. **Create `ChatToolbar.swift`** in `MessageAI/Presentation/Views/Chat/`

```swift
//
//  ChatToolbar.swift
//  MessageAI
//
//  Story 3.2: ChatView Refactoring for AI Integration
//

import SwiftUI

struct ChatToolbar: View {
    let conversationTitle: String
    let isGroupConversation: Bool
    let onShowGroupMembers: () -> Void
    let onShowAIMenu: () -> Void

    var body: some View {
        Group {
            // Title item
            titleItem

            // AI button
            aiButton
        }
    }

    @ToolbarContentBuilder
    private var titleItem: some ToolbarContent {
        ToolbarItem(placement: .principal) {
            if isGroupConversation {
                Button(action: onShowGroupMembers) {
                    Text(conversationTitle)
                        .font(.headline)
                        .foregroundColor(.primary)
                }
                .accessibilityLabel("Group members: \(conversationTitle)")
                .accessibilityHint("Tap to view group member list")
            } else {
                Text(conversationTitle)
                    .font(.headline)
            }
        }
    }

    @ToolbarContentBuilder
    private var aiButton: some ToolbarContent {
        ToolbarItem(placement: .navigationBarTrailing) {
            Button(action: onShowAIMenu) {
                Image(systemName: "sparkles")
                    .foregroundColor(.blue)
            }
            .accessibilityLabel("AI Features")
            .accessibilityHint("Access AI-powered features like thread summarization")
        }
    }
}
```

2. **Update ChatView.swift**: Replace toolbar content

**Find** (around line 127):
```swift
.toolbar {
    ToolbarItem(placement: .principal) {
        if viewModel.isGroupConversation {
            // Group: Tappable title to show member list
            Button(action: {
                showGroupMemberList = true
            }) {
                Text(conversationTitle)
                    .font(.headline)
                    .foregroundColor(.primary)
            }
            .accessibilityLabel("Group members: \(conversationTitle)")
            .accessibilityHint("Tap to view group member list")
        } else {
            // One-on-one: Just show title
            Text(conversationTitle)
                .font(.headline)
        }
    }

    // Story 3.2: AI Features Button - Temporarily disabled...
    /* ... */
}
```

**Replace with**:
```swift
.toolbar {
    ChatToolbar(
        conversationTitle: conversationTitle,
        isGroupConversation: viewModel.isGroupConversation,
        onShowGroupMembers: { showGroupMemberList = true },
        onShowAIMenu: { showAIMenu = true }
    )
}
```

3. **Uncomment AI state variables** (lines 20-24):

```swift
// AI features state (Story 3.2)
@State private var showAIMenu = false
@State private var showSummary = false
@State private var summaryViewModel: SummaryViewModel?
```

4. **Uncomment AI sheets** (lines 188-205):

```swift
// Story 3.2: AI Features
.confirmationDialog("AI Features", isPresented: $showAIMenu) {
    Button("Summarize Thread") {
        summaryViewModel = DIContainer.shared.makeSummaryViewModel(
            conversationId: viewModel.conversationId
        )
        showSummary = true
    }
    Button("Cancel", role: .cancel) {}
} message: {
    Text("Choose an AI feature to use")
}
.sheet(isPresented: $showSummary) {
    summarySheetContent
}
```

5. **Uncomment helper property** (lines 477-490):

```swift
// Story 3.2: Summary sheet content
@ViewBuilder
private var summarySheetContent: some View {
    if let summaryVM = summaryViewModel {
        SummaryView(viewModel: summaryVM)
            .onAppear {
                Task {
                    await summaryVM.loadSummary()
                }
            }
    }
}
```

6. **Build and test**:
```bash
./scripts/build.sh
./scripts/quick-test.sh -q
```

**Expected Result**: Build should succeed with toolbar extracted.

---

### Phase 2: Test AI Integration (After Phase 1 Succeeds)

1. **Manual Testing**:
   - Run app on simulator
   - Sign in and open any conversation
   - Tap the ✨ sparkles button in toolbar
   - Verify "AI Features" menu appears
   - Tap "Summarize Thread"
   - Verify SummaryView modal appears
   - Verify loading state shows "Analyzing conversation..."

2. **Test with Mock Data**:
   - Summary will show placeholder data from Cloud Functions (Story 3.1 mock implementation)
   - Expected: "This is a placeholder summary..." with mock key points

3. **Test Error Handling**:
   - Turn on airplane mode
   - Try to generate summary
   - Verify error message appears

---

### Phase 3: Integration Tests (Optional)

**Create** `MessageAITests/Integration/SummaryIntegrationTests.swift`:

```swift
//
//  SummaryIntegrationTests.swift
//  MessageAITests
//
//  Story 3.2: Thread Summarization Integration Tests
//

import XCTest
@testable import MessageAI

@MainActor
final class SummaryIntegrationTests: XCTestCase {

    func testSummaryFeatureEndToEnd() async throws {
        // Skip if emulator not running
        try XCTSkipIf(true, "Requires Firebase Emulator - start with ./scripts/start-emulator.sh")

        // Test implementation here
        // 1. Create test conversation with messages
        // 2. Call summarizeThread via CloudFunctionsService
        // 3. Verify response structure
        // 4. Verify cached result on second call
    }
}
```

**Run with emulator**:
```bash
# Terminal 1
./scripts/start-emulator.sh

# Terminal 2
./scripts/quick-test.sh --test SummaryIntegrationTests --with-integration
```

---

## Alternative Solution: Add AI Button Elsewhere (If Refactoring Takes Too Long)

### Option A: Conversations List Context Menu

Add AI features to conversation context menu in ConversationsListView:

**Location**: `MessageAI/Presentation/Views/Conversations/ConversationsListView.swift`

**Add to conversation row**:
```swift
.contextMenu {
    // Existing menu items...

    Divider()

    Button {
        selectedConversationForSummary = conversation
        showSummary = true
    } label: {
        Label("Summarize Thread", systemImage: "sparkles")
    }
}
```

**Pros**:
- Quick to implement
- No ChatView changes needed
- Accessible from conversation list

**Cons**:
- Not in-chat as per Story 3.2 spec
- Requires navigating away from chat

---

### Option B: Message Long-Press Menu

Add "Summarize from here" to message long-press menu:

**Location**: `MessageKitWrapper` message action sheet

**Pros**:
- Contextual to specific messages
- Can summarize "from this message onwards"

**Cons**:
- Not the primary access point specified in Story 3.2
- More complex UX

---

## Files Modified in Story 3.2

### Created Files ✅
1. `MessageAI/Presentation/ViewModels/SummaryViewModel.swift` (153 lines)
2. `MessageAI/Presentation/Views/SummaryView.swift` (318 lines)
3. `MessageAITests/Presentation/ViewModels/SummaryViewModelTests.swift` (360 lines)

### Modified Files ✅
1. `MessageAI/App/DIContainer.swift` - Added `makeSummaryViewModel()` factory
2. `MessageAI/Presentation/Views/Chat/ChatView.swift` - AI integration (commented out)

### Files to Create (Phase 1)
1. `MessageAI/Presentation/Views/Chat/ChatToolbar.swift` (50 lines)

---

## Testing Checklist

### Unit Tests ✅
- [x] 12 SummaryViewModel tests passing
- [x] All tests cover loading, error, caching, regeneration

### Integration Tests ⚠️
- [ ] End-to-end test with Firebase Emulator
- [ ] Test cache hit/miss behavior
- [ ] Test error scenarios (network failures)

### Manual Testing
- [ ] AI button appears in ChatView toolbar
- [ ] Tapping button shows "AI Features" menu
- [ ] "Summarize Thread" option works
- [ ] Loading modal appears with progress indicator
- [ ] Summary displays correctly with all sections
- [ ] "Regenerate" button works
- [ ] "Close" button dismisses modal
- [ ] Cached indicator shows when applicable
- [ ] Error messages display user-friendly text
- [ ] Works in both 1-on-1 and group conversations

---

## Acceptance Criteria Validation

| AC | Requirement | Status | Notes |
|----|-------------|--------|-------|
| 1 | AI button in chat toolbar | ⚠️ | Implemented but commented out |
| 2 | Tap shows contextual menu | ⚠️ | Implemented but commented out |
| 3 | Loading modal | ✅ | Complete with "Analyzing conversation..." |
| 4 | Summary display | ✅ | Shows summary, key points, participants |
| 5 | Regenerate & Close buttons | ✅ | Fully functional |
| 6 | Summary persistence | ✅ | Shows timestamp and cached indicator |
| 7 | Cloud Function call | ✅ | Uses Story 3.1 infrastructure |
| 8-10 | LLM prompt & structure | ✅ | Backend ready (Story 3.1) |
| 11-15 | Quality criteria | ⚠️ | Backend mock only (Story 3.5) |
| 16-19 | Performance & caching | ✅ | Backend implements caching |
| 20 | Integration test | ⚠️ | Pending emulator setup |
| 21 | Regression test | ✅ | All existing tests pass |

---

## Estimated Time

- **Phase 1 (Toolbar Refactoring)**: 30-45 minutes
- **Phase 2 (Manual Testing)**: 15-20 minutes
- **Phase 3 (Integration Tests)**: 30-45 minutes (optional)

**Total**: 1-2 hours to complete Story 3.2

---

## Rollback Plan

If Phase 1 refactoring causes issues:

1. Revert ChatToolbar creation
2. Keep AI integration commented out in ChatView
3. Implement Alternative Option A (Conversations List Context Menu)
4. Document as technical debt for future ChatView refactoring

---

## Next Story Dependencies

**Story 3.3** (Action Item Extraction) will face the same ChatView complexity issue. The toolbar refactoring done in Phase 1 will benefit all future AI features.

**Recommendation**: Complete Phase 1 now to unblock all Epic 3 stories.

---

## Questions?

If you encounter issues:
1. Check that all commented sections are properly uncommented
2. Verify ChatToolbar.swift is added to Xcode project target
3. Run `./scripts/build.sh --action clean` if needed
4. Check compiler errors carefully - they may point to typos in refactoring

---

**Author**: Claude Code
**Date**: 2025-10-23
**Story**: 3.2 Thread Summarization Feature
**Status**: Ready for Phase 1 Implementation
