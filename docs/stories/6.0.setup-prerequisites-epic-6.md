# Story 6.0: Setup & Prerequisites for Epic 6

## Status

**Draft**

---

## Story

**As a** developer,
**I want** to set up all required infrastructure and configurations for Epic 6,
**so that** Stories 6.1-6.6 can be implemented without environment issues.

---

## Overview

This story handles all **one-time setup tasks** required before implementing Epic 6 (Smart AI-Powered Notifications). This includes:
- OpenAI API configuration
- Firestore security rules
- Firestore indexes
- Cloud Functions environment setup
- Firebase project configuration

**Complete this story BEFORE starting Stories 6.1-6.6.**

---

## Acceptance Criteria

**OpenAI API Setup:**
1. Obtain OpenAI API key from https://platform.openai.com/api-keys
2. Configure API key in Firebase Functions environment (both dev and prod)
3. Create `.runtimeconfig.json` for local emulator testing
4. Add `.runtimeconfig.json` to `.gitignore`
5. Verify API key works with test embedding call

**Firestore Security Rules:**
6. Add rules for `message_embeddings` collection (read: authenticated, write: server only)
7. Add rules for `ai_notification_cache` collection (read: owner only, write: server only)
8. Add rules for `notification_decisions` collection (read: owner only, write: server only)
9. Add rules for `notification_feedback` collection (read: owner only, write: authenticated)
10. Add rules for `user_activity` collection (read: server only, write: authenticated)
11. Add rules for `ai_notification_preferences` subcollection (read/write: owner only)
12. Add rules for `rate_limits` collection (read/write: server only)
13. Deploy rules to dev environment

**Firestore Indexes:**
14. Create composite index: `message_embeddings` on `conversationId + timestamp (DESC)`
15. Create composite index: `message_embeddings` on `participantIds (ARRAY) + timestamp (DESC)`
16. Create composite index: `notification_decisions` on `userId + timestamp (DESC)`
17. Create composite index: `notification_feedback` on `userId + timestamp (DESC)`
18. Deploy indexes to dev environment

**Cloud Functions Dependencies:**
19. Install OpenAI SDK: `npm install openai` in `functions/` directory
20. Install crypto module if not already available (built-in to Node.js)
21. Update `functions/package.json` with correct dependencies
22. Run `npm install` to verify all dependencies resolve

**Environment Validation:**
23. Test Cloud Function can access OpenAI API (simple embedding test)
24. Test Firestore rules allow expected operations
25. Test Firestore indexes are active (not still building)
26. Verify Firebase project quotas sufficient (Firestore reads/writes, Cloud Function invocations)

**Documentation:**
27. Document OpenAI API key rotation procedure
28. Document Firestore index management
29. Add troubleshooting guide for common setup issues

---

## Tasks / Subtasks

- [ ] Obtain and configure OpenAI API key (AC: 1-5)
  - [ ] Sign up for OpenAI account at https://platform.openai.com
  - [ ] Generate API key from dashboard
  - [ ] Set in Firebase dev environment: `firebase functions:config:set openai.api_key="sk-..." --project=messageai-dev-1f2ec`
  - [ ] Set in Firebase prod environment: `firebase functions:config:set openai.api_key="sk-..." --project=messageai-prod-4d3a8`
  - [ ] Create `.runtimeconfig.json` in `functions/` directory:
    ```json
    {
      "openai": {
        "api_key": "sk-your-dev-key-here"
      }
    }
    ```
  - [ ] Add `.runtimeconfig.json` to `.gitignore`
  - [ ] Test with simple embedding call (see Dev Notes)

- [ ] Update Firestore security rules (AC: 6-13)
  - [ ] Create backup of current `firestore.rules`
  - [ ] Add new collection rules (see Dev Notes for complete rules)
  - [ ] Deploy to dev: `firebase deploy --only firestore:rules --project=messageai-dev-1f2ec`
  - [ ] Test rules with Firebase Emulator
  - [ ] Verify rules work as expected

- [ ] Create Firestore indexes (AC: 14-18)
  - [ ] Update `firestore.indexes.json` with required indexes (see Dev Notes)
  - [ ] Deploy indexes: `firebase deploy --only firestore:indexes --project=messageai-dev-1f2ec`
  - [ ] Monitor index build status in Firebase Console
  - [ ] Wait for indexes to become active (can take 5-15 minutes)

- [ ] Install Cloud Functions dependencies (AC: 19-22)
  - [ ] Navigate to `functions/` directory
  - [ ] Run: `npm install openai`
  - [ ] Verify `package.json` updated correctly
  - [ ] Run: `npm install` to ensure all dependencies resolve
  - [ ] Check for any peer dependency warnings

- [ ] Validate environment setup (AC: 23-26)
  - [ ] Create test Cloud Function to verify OpenAI access
  - [ ] Deploy test function: `firebase deploy --only functions:testOpenAI --project=messageai-dev-1f2ec`
  - [ ] Call test function, verify embedding returned
  - [ ] Test Firestore rules in emulator
  - [ ] Check Firebase project quotas (Firestore, Cloud Functions)

- [ ] Create setup documentation (AC: 27-29)
  - [ ] Document API key rotation in `docs/setup/openai-api-key-rotation.md`
  - [ ] Document index management in `docs/setup/firestore-indexes.md`
  - [ ] Create troubleshooting guide in `docs/setup/epic-6-troubleshooting.md`

---

## Dev Notes

### OpenAI API Key Configuration

**Get API Key:**
1. Go to https://platform.openai.com/api-keys
2. Create new secret key
3. Copy key immediately (won't be shown again)

**Configure in Firebase:**
```bash
# Development environment
firebase functions:config:set openai.api_key="sk-..." --project=messageai-dev-1f2ec

# Production environment
firebase functions:config:set openai.api_key="sk-..." --project=messageai-prod-4d3a8

# View current config
firebase functions:config:get --project=messageai-dev-1f2ec
```

**Local Emulator Setup:**
Create `functions/.runtimeconfig.json`:
```json
{
  "openai": {
    "api_key": "sk-your-dev-key-here"
  }
}
```

**IMPORTANT:** Add to `.gitignore`:
```
functions/.runtimeconfig.json
```

**Test OpenAI Access:**
```typescript
// functions/src/testOpenAI.ts
import * as functions from 'firebase-functions';
import OpenAI from 'openai';

export const testOpenAI = functions.https.onCall(async (data, context) => {
  const openai = new OpenAI({
    apiKey: functions.config().openai.api_key
  });

  try {
    const response = await openai.embeddings.create({
      model: "text-embedding-ada-002",
      input: "test message"
    });

    return {
      success: true,
      embeddingLength: response.data[0].embedding.length,
      message: "OpenAI API configured correctly!"
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
});
```

Deploy and test:
```bash
firebase deploy --only functions:testOpenAI --project=messageai-dev-1f2ec
# Call from app or Firebase Console
```

---

### Firestore Security Rules

Add these rules to `firestore.rules`:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Existing rules...

    // === Epic 6: Smart Notifications Rules ===

    // Message embeddings (write-only from Cloud Functions)
    match /message_embeddings/{embeddingId} {
      allow read: if request.auth != null; // Authenticated users can read
      allow write: if false; // Only server (Cloud Functions) can write
    }

    // AI notification cache (read by owner, write by server)
    match /ai_notification_cache/{cacheId} {
      allow read: if request.auth != null &&
                    resource.data.userId == request.auth.uid;
      allow write: if false; // Only server can write
    }

    // Notification decisions log (read by owner, write by server)
    match /notification_decisions/{decisionId} {
      allow read: if request.auth != null &&
                    resource.data.userId == request.auth.uid;
      allow write: if false; // Only server can write
    }

    // Notification feedback (read by owner, write by authenticated)
    match /notification_feedback/{feedbackId} {
      allow read: if request.auth != null &&
                    resource.data.userId == request.auth.uid;
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid;
      allow update: if false; // No updates, only create
      allow delete: if false; // No deletes
    }

    // User activity tracking (for active conversation suppression)
    match /user_activity/{userId} {
      allow read: if false; // Only server reads this
      allow write: if request.auth != null &&
                     userId == request.auth.uid;
    }

    // Rate limits (server-only)
    match /rate_limits/{userId} {
      allow read, write: if false; // Only server
    }

    // User notification preferences (subcollection)
    match /users/{userId}/ai_notification_preferences/{doc} {
      allow read, write: if request.auth != null &&
                           userId == request.auth.uid;
    }

    // AI notification profile (subcollection, read/write by owner)
    match /users/{userId}/ai_notification_profile/{doc} {
      allow read: if request.auth != null &&
                    userId == request.auth.uid;
      allow write: if false; // Only server updates profile
    }

    // False negatives log (optional, server-only)
    match /false_negatives/{docId} {
      allow read, write: if false; // Only server
    }

    // AI usage logs (server-only)
    match /ai_usage_logs/{logId} {
      allow read, write: if false; // Only server
    }
  }
}
```

**Deploy:**
```bash
firebase deploy --only firestore:rules --project=messageai-dev-1f2ec
```

---

### Firestore Indexes

Update `firestore.indexes.json`:

```json
{
  "indexes": [
    {
      "collectionGroup": "message_embeddings",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "conversationId", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "message_embeddings",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "participantIds", "arrayConfig": "CONTAINS" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "notification_decisions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "notification_feedback",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

**Deploy:**
```bash
firebase deploy --only firestore:indexes --project=messageai-dev-1f2ec
```

**Monitor index build progress:**
- Go to Firebase Console → Firestore → Indexes
- Wait for all indexes to show "Enabled" status (not "Building")
- Typically takes 5-15 minutes for small datasets

---

### Cloud Functions Dependencies

**Install OpenAI SDK:**
```bash
cd functions
npm install openai
```

**Verify `package.json`:**
```json
{
  "name": "functions",
  "scripts": {
    "build": "tsc",
    "serve": "npm run build && firebase emulators:start --only functions",
    "shell": "npm run build && firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "18"
  },
  "main": "lib/index.js",
  "dependencies": {
    "firebase-admin": "^11.8.0",
    "firebase-functions": "^4.3.1",
    "openai": "^4.20.0"
  },
  "devDependencies": {
    "typescript": "^4.9.0",
    "firebase-functions-test": "^3.1.0"
  },
  "private": true
}
```

---

### Environment Validation Checklist

- [ ] OpenAI API key configured in Firebase
- [ ] Local `.runtimeconfig.json` created and gitignored
- [ ] Test function successfully calls OpenAI API
- [ ] Firestore security rules deployed
- [ ] All Firestore indexes built and enabled
- [ ] Cloud Functions dependencies installed
- [ ] Firebase project quotas checked (sufficient for demo)

---

### Troubleshooting

**Problem:** `Error: functions.config().openai is undefined`
**Solution:**
- Verify config set: `firebase functions:config:get`
- Redeploy functions after setting config
- For emulator: Ensure `.runtimeconfig.json` exists in `functions/`

**Problem:** `Error: 9 FAILED_PRECONDITION: The query requires an index`
**Solution:**
- Deploy indexes: `firebase deploy --only firestore:indexes`
- Wait for indexes to build (check Firebase Console)
- Don't run queries until indexes show "Enabled"

**Problem:** `Error: OpenAI API rate limit exceeded`
**Solution:**
- Check OpenAI account usage limits
- Upgrade to paid tier if needed
- For bootcamp demo: Basic tier should be sufficient

**Problem:** `Error: Permission denied` on Firestore write
**Solution:**
- Check `firestore.rules` deployed correctly
- Verify user authentication state
- Test rules in Firebase Emulator first

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial setup story creation | Winston (Architect) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
